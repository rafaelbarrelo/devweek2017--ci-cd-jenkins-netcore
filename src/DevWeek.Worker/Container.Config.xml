<?xml version="1.0" encoding="utf-8" ?>
<objects xmlns="http://www.springframework.net" xmlns:aop="http://www.springframework.net/aop">

    <!--RabbitMQ-->
    <!--###############################################-->
    <object name="RabbitMQ_ConnectionFactory" type="RabbitMQ.Client.ConnectionFactory, RabbitMQ.Client">
        <property name="Uri" ref="CONFIG:DevWeek:RabbitMQ:ConnectionString" />
        <property name="AutomaticRecoveryEnabled" value="true"  />
        <property name="NetworkRecoveryInterval" value="00:00:10"  />
    </object>
    <object name="RabbitMQ_Connection" factory-object="RabbitMQ_ConnectionFactory" factory-method="CreateConnection" singleton="false" ></object>
    <object name="RabbitMQ_Model" type="RabbitMQ.Client.IModel, RabbitMQ.Client" factory-object="RabbitMQ_Connection" factory-method="CreateModel" singleton="false"></object>


    <!--Redis-->
    <!--###############################################-->
    <object name="RedisClient" type="StackExchange.Redis.ConnectionMultiplexer, StackExchange.Redis.StrongName" factory-method="Connect">
        <constructor-arg name="configuration" ref="CONFIG:DevWeek:Redis:ConnectionString" />
        <constructor-arg name="log" >
            <null />
        </constructor-arg>
    </object>

    <!--MongoDB-->
    <!--###############################################-->
    <object name="MongoClient" type="MongoDB.Driver.MongoClient, MongoDB.Driver">
        <constructor-arg name="connectionString" ref="CONFIG:DevWeek:MongoDB:ConnectionString" />
    </object>

    <!--S3-->
    <!--###############################################-->
    <object type="Minio.MinioClient, Minio">
        <constructor-arg name="endpoint" ref="CONFIG:DevWeek:S3:Endpoint" />
        <constructor-arg name="accessKey" ref="CONFIG:DevWeek:S3:AccessKey" />
        <constructor-arg name="secretKey" ref="CONFIG:DevWeek:S3:SecretKey" />
        <constructor-arg name="region" value="" />
    </object>


    <object type="DevWeek.Services.ResourceBootstrapService" autowire="constructor" init-method="Check">
        <property name="DownloadPipelineQueue"    ref="CONFIG:DevWeek:RabbitMQ:DownloadPipeline:Queue" />
        <property name="DownloadPipelineRouteKey" ref="CONFIG:DevWeek:RabbitMQ:DownloadPipeline:RouteKey" />
        <property name="DownloadPipelineExchange" ref="CONFIG:DevWeek:RabbitMQ:DownloadPipeline:Exchange" />
        <property name="LockTimeout" value="00:00:30" />
        <property name="MongoRequiredCollections" value="media_download" />
        <property name="MinioBucketNames" >
            <object type="string[]" >
                <constructor-arg value="2" />
                <property name="[0]" ref="CONFIG:DevWeek:S3:AudioBucketName" />
                <property name="[1]" ref="CONFIG:DevWeek:S3:VideoBucketName" />
            </object>
        </property>
        <property name="DistributedLockKey" value="init-infrastructure-lock" />
    </object>

    <object name="DistributedLockService" type="DevWeek.Services.DistributedLockService, DevWeek.Services" autowire="constructor">
        <property name="WaitingLockCycle" value="00:00:00.200"></property>
    </object>

    <object type="DevWeek.Services.Downloader.DownloadPipeline, DevWeek.Services">
        <property name="Activities">
            <list element-type="DevWeek.Services.Downloader.IPipelineActivity, DevWeek.Contracts" >
                <object type="DevWeek.Services.Downloader.EntryPointRegisterPipelineActivity, DevWeek.Services" autowire="constructor"></object>
                <object type="DevWeek.Services.Downloader.MetadataDiscoveryPipelineActivity, DevWeek.Services" autowire="constructor"></object>
                <object type="DevWeek.Services.Downloader.MediaDownloaderPipelineActivity, DevWeek.Services" autowire="constructor"></object>
                <object type="DevWeek.Services.Downloader.S3MediaUploaderPipelineActivity, DevWeek.Services" autowire="constructor"></object>
                <object type="DevWeek.Services.Downloader.CleanupPipelineActivity, DevWeek.Services"  autowire="constructor"></object>
            </list>
        </property>
        <property name="Context">
            <dictionary  key-type="string" value-type="object">
                <entry key="localTemporaryFolder" value-ref="CONFIG:DevWeek:LocalTemporaryFolder" />
                <entry key="audioBucketName" value-ref="CONFIG:DevWeek:S3:AudioBucketName" />
                <entry key="videoBucketName" value-ref="CONFIG:DevWeek:S3:VideoBucketName" />
            </dictionary>
        </property>
    </object>


    <object type="DevWeek.Services.DataService, DevWeek.Services"  autowire="constructor">
        <constructor-arg name="redis" ref="RedisClient"/>
        <constructor-arg name="mongoClient" ref="MongoClient"/>
        <constructor-arg name="distributedLockService" ref="DistributedLockService"/>
        <constructor-arg name="redisDownloadListKey" ref="CONFIG:DevWeek:Redis:DownloadListKey"/>
        <constructor-arg name="mongoDownloadCollectionName" ref="CONFIG:DevWeek:MongoDB:MongoDownloadCollectionName"/>
    </object>

</objects>